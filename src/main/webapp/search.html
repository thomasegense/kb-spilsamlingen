<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Solr Search — Pagination + Pinned Tooltip</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    h1 { text-align: center; margin-bottom: 1rem; }
    #searchBox {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }

    .layout { display: flex; align-items: flex-start; gap: 1rem; }
    .facets {
      flex: 0 0 250px;
      background: #f8f9fb;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      overflow-y: auto;
      max-height: 80vh;
    }
    .results {
      flex: 1;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      min-height: 300px;
      position: relative;
    }

    .result-item { padding: 0.6rem 0; border-bottom: 1px solid #e6e9ee; }
    .result-item:last-child { border-bottom: none; }
    .field-name { font-weight: 600; display: inline-block; min-width: 180px; }
    .field-meta { font-size: 0.85rem; color: #666; margin-left: 6px; }
    .field-value { display: inline-block; vertical-align: top; max-width: 740px; word-break: break-word; position: relative; }
    ul.field-list { margin: 0.25rem 0 0.5rem 1.2rem; padding: 0; list-style: disc; }

    pre.json-block {
      background: #fefefe;
      border: 1px solid #eee;
      padding: 0.5rem;
      border-radius: 6px;
      overflow: auto;
      max-height: 240px;
    }

    .facet-block { margin-bottom: 1rem; }
    .facet-title { font-weight: 700; margin-bottom: 0.25rem; }
    .facet-value {
      cursor: pointer;
      display: inline-block;
      margin: 0 0.5rem 0.25rem 0;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #dfe7f3;
      background: #fff;
      font-size: 0.9rem;
    }
    .facet-value:hover { background: #eef3ff; }
    .badge {
      display: inline-block;
      padding: 0.08rem 0.45rem;
      border-radius: 999px;
      background: #eef3ff;
      color: #0b57d0;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .page-btn {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
    }
    .page-btn:hover { background: #e9eefb; }
    .page-btn:disabled {
      background: #eee;
      color: #888;
      cursor: not-allowed;
    }

    /* Tooltip */
    .tooltip-box {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 600px;
      max-height: 400px;
      overflow: auto;
      z-index: 100;
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .tooltip-pinned {
      border-color: #007bff;
      box-shadow: 0 2px 12px rgba(0, 0, 255, 0.25);
    }

    @media (max-width: 800px) {
      .layout { flex-direction: column; }
      .facets { flex: 1; max-height: none; order: -1; }
    }
  </style>
</head>
<body>
  <h1>Solr Search</h1>

  <input id="searchBox" type="text" placeholder="Enter query and press Enter (e.g. *:*)" />

  <div class="layout">
    <div id="facets" class="facets"></div>
    <div id="results" class="results"></div>
  </div>

  <div id="tooltip" class="tooltip-box"></div>

  <script>
    const SOLR_URL = "http://localhost:8081/kb-spilsamlingen/v1/search";
    const ROWS_PER_PAGE = 10;
    let currentQuery = "*:*";
    let currentStart = 0;
    let totalFound = 0;

    const searchBox = document.getElementById('searchBox');
    const resultsDiv = document.getElementById('results');
    const facetsDiv = document.getElementById('facets');
    const tooltip = document.getElementById('tooltip');
    let pinnedElement = null;

    searchBox.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        currentQuery = searchBox.value || '*:*';
        currentStart = 0;
        performSearch();
      }
    });

    async function performSearch() {
      resultsDiv.innerHTML = 'Loading...';
      facetsDiv.innerHTML = '';

      const params = new URLSearchParams({
        q: currentQuery,
        wt: 'json',
        rows: ROWS_PER_PAGE.toString(),
        start: currentStart.toString(),
        facet: 'true',
        'facet.field': ['category', 'author']
      });

      try {
        const res = await fetch(`${SOLR_URL}?${params.toString()}`);
        const data = await res.json();
        if (!data.response || !Array.isArray(data.response.docs)) {
          resultsDiv.innerHTML = '<em>Unexpected Solr response — no response.docs found.</em>';
          return;
        }
        totalFound = data.response.numFound || 0;
        renderFacets(data.facet_counts || {});
        renderResults(data.response);
      } catch (err) {
        resultsDiv.innerHTML = `<span style="color:crimson">Error: ${err.message}</span>`;
      }
    }

    function renderFacets(facetCounts) {
      if (!facetCounts || !facetCounts.facet_fields) {
        facetsDiv.innerHTML = '<em>No facets</em>';
        return;
      }
      const fields = facetCounts.facet_fields;
      let html = '<h3 style="margin-top:0">Facets</h3>';
      for (const [field, values] of Object.entries(fields)) {
        if (!values || values.length === 0) continue;
        html += `<div class="facet-block"><div class="facet-title">${escapeHtml(field)}</div><div>`;
        for (let i = 0; i < values.length; i += 2) {
          const val = values[i];
          const count = values[i + 1];
          html += `<span class="facet-value" onclick="facetSearch('${field}:${escapeJsString(val)}')">${escapeHtml(val)} <span class="badge">${count}</span></span>`;
        }
        html += `</div></div>`;
      }
      facetsDiv.innerHTML = html;
    }

    function facetSearch(query) {
      currentQuery = query;
      currentStart = 0;
      searchBox.value = query;
      performSearch();
    }

    function renderResults(response) {
      const docs = response.docs || [];
      if (docs.length === 0) {
        resultsDiv.innerHTML = '<em>No results</em>';
        return;
      }

      const header = `<div style="margin-bottom:8px"><strong>Showing ${currentStart + 1}-${Math.min(currentStart + docs.length, totalFound)} of ${totalFound}</strong></div>`;
      const body = docs.map((doc, idx) => renderDoc(doc, idx)).join('');
      const pagination = renderPagination();

      resultsDiv.innerHTML = header + body + pagination;

      document.querySelectorAll('[data-full-value]').forEach(el => {
        el.addEventListener('mouseenter', showTooltip);
        el.addEventListener('mouseleave', hideTooltip);
        el.addEventListener('click', togglePinTooltip);
      });
    }

    function renderPagination() {
      const prevDisabled = currentStart <= 0;
      const nextDisabled = currentStart + ROWS_PER_PAGE >= totalFound;

      return `
        <div class="pagination">
          <button class="page-btn" ${prevDisabled ? 'disabled' : ''} onclick="changePage(-1)">Previous</button>
          <button class="page-btn" ${nextDisabled ? 'disabled' : ''} onclick="changePage(1)">Next</button>
        </div>
      `;
    }

    function changePage(direction) {
      const newStart = currentStart + direction * ROWS_PER_PAGE;
      if (newStart < 0 || newStart >= totalFound) return;
      currentStart = newStart;
      performSearch();
    }

    function renderDoc(doc, idx) {
      const pairs = Object.entries(doc).map(([key, rawValue]) => {
        const { kind, html } = renderFieldValue(rawValue);
        return `
          <div style="padding:6px 0;">
            <span class="field-name">${escapeHtml(key)}</span>
            <span class="field-meta">${kind}</span>
            <div class="field-value">${html}</div>
          </div>`;
      }).join('');

      return `<div class="result-item">
        <div style="margin-bottom:6px"><strong>Document ${currentStart + idx + 1}</strong></div>
        ${pairs}
      </div>`;
    }

    function renderFieldValue(v) {
      if (v === null || v === undefined)
        return { kind: '<span style="color:#999">null</span>', html: '<em>null</em>' };
      if (Array.isArray(v))
        return { kind: '<span style="color:#0b57d0">multi-valued</span>', html: renderArray(v) };
      if (typeof v === 'object')
        return { kind: '<span style="color:#0b57d0">object</span>', html: `<pre class="json-block">${escapeHtml(JSON.stringify(v, null, 2))}</pre>` };
      return { kind: '<span style="color:#2a7a2a">single-valued</span>', html: renderTruncatedValue(v) };
    }

    function renderArray(arr) {
      const items = arr.map(it => renderTruncatedValue(it, true)).join('');
      return `<ul class="field-list">${items}</ul>`;
    }

    function renderTruncatedValue(value, asListItem = false) {
      const valStr = String(value);
      const truncated = valStr.length > 50 ? valStr.substring(0, 50) + "…" : valStr;
      const escapedFull = escapeHtml(valStr);
      const escapedShort = escapeHtml(truncated);
      const html = `<span data-full-value="${escapedFull}">${escapedShort}</span>`;
      return asListItem ? `<li>${html}</li>` : html;
    }

    // Tooltip behavior
    function showTooltip(e) {
      if (pinnedElement && pinnedElement !== e.target) return;
      const full = e.target.getAttribute('data-full-value');
      if (!full || full.length <= 50) return;
      tooltip.textContent = full;
      positionTooltip(e.target);
      tooltip.style.display = 'block';
      tooltip.classList.toggle('tooltip-pinned', !!pinnedElement);
    }

    function hideTooltip(e) {
      if (pinnedElement === e.target) return;
      if (!pinnedElement) tooltip.style.display = 'none';
    }

    function togglePinTooltip(e) {
      const target = e.target;
      const full = target.getAttribute('data-full-value');
      if (!full || full.length <= 50) return;
      if (pinnedElement === target) {
        pinnedElement = null;
        tooltip.style.display = 'none';
        tooltip.classList.remove('tooltip-pinned');
      } else {
        pinnedElement = target;
        tooltip.textContent = full;
        tooltip.classList.add('tooltip-pinned');
        positionTooltip(target);
        tooltip.style.display = 'block';
      }
      e.stopPropagation();
    }

    document.addEventListener('click', (e) => {
      if (pinnedElement && !tooltip.contains(e.target) && e.target !== pinnedElement) {
        pinnedElement = null;
        tooltip.style.display = 'none';
        tooltip.classList.remove('tooltip-pinned');
      }
    });

    function positionTooltip(target) {
      const rect = target.getBoundingClientRect();
      tooltip.style.top = window.scrollY + rect.bottom + 5 + 'px';
      tooltip.style.left = Math.min(window.scrollX + rect.left, window.innerWidth - tooltip.offsetWidth - 20) + 'px';
    }

    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function escapeJsString(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/(['"\\])/g, '\\$1');
    }

    // Auto-start example
    // performSearch();
  </script>
</body>
</html>